variant: flatcar
version: 1.0.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - 'sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIH+F6Cm0HPSAJKwXaTPGo+6EQK7d00Wz5i/EdlG1PVOlAAAAGHNzaDpnaXRodWIteWstczUtbmFuby1hMQ== ssh:github-yk-s5-nano-a1'
      groups: [ sudo, docker ]

storage:
  files:
    - path: /etc/flatcar/update.conf
      overwrite: true
      mode: 0644
      contents:
        inline: |
          REBOOT_STRATEGY=best-effort

    - path: /etc/hostname
      mode: 0644
      contents:
        inline: athena.spacectl.arpa

    - path: /etc/sudoers.d/core
      mode: 0440
      contents:
        inline: |
          core ALL=(ALL) NOPASSWD: ALL

    # Explicitly create authorized_keys with correct permissions
    - path: /home/core/.ssh/authorized_keys
      mode: 0600
      user:
        name: core
      group:
        name: core
      contents:
        inline: |
          # auto-generated by ignition
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBci1xz1g+pS9xs+KA6ymADE4w5rlrf+AXiQSP/mE/uH flatcar-spacectl

    - path: /etc/systemd/network/10-enp2s0.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=enp2s0

          [Network]
          DHCP=yes
    - path: /etc/systemd/network/10-enp3s0.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=enp3s0

          [Network]
          DHCP=yes
    - path: /etc/systemd/network/10-enp4s0.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=enp4s0

          [Network]
          DHCP=yes
    - path: /etc/systemd/network/10-enp5s0.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=enp5s0

          [Network]
          DHCP=yes
    - path: /etc/systemd/network/10-enp6s0.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=enp6s0

          [Network]
          DHCP=yes

systemd:
  units:
    - name: sshd.service
      enabled: true

    - name: systemd-networkd.service
      enabled: true

    - name: update-engine.service
      enabled: true

    - name: locksmithd.service
      enabled: true
      mask: false

    # Permission recovery service as additional protection
    - name: ssh-permission-fix.service
      enabled: true
      contents: |
        [Unit]
        Description=Ensure SSH authorized_keys has correct permissions
        After=multi-user.target
        Before=sshd.service

        [Service]
        Type=oneshot
        ExecStart=/bin/bash -c 'if [[ -f /home/core/.ssh/authorized_keys ]] && [[ $(stat -c %%a /home/core/.ssh/authorized_keys) != "600" ]]; then chmod 600 /home/core/.ssh/authorized_keys && chown core:core /home/core/.ssh/authorized_keys; fi'

        [Install]
        WantedBy=multi-user.target

